// ========== CONFIGURATION ==========
    const ADMIN_PASSWORD = 'admin123'; // Change this!
    const RELAY_SERVER_URL = 'wss://agent-app-talk.onrender.com';

    // ========== STATE ==========
    let relaySocket = null;
    let isAuthenticated = false;
    let activeUser = null;
    let waitingQueue = [];
    let unityCount = 0;
    let avatarState = 'idle';
    let connectedAt = null;

    // ========== DOM ELEMENTS ==========
    const loginScreen = document.getElementById('loginScreen');
    const adminPanel = document.getElementById('adminPanel');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const errorMessage = document.getElementById('errorMessage');

    const connectionIndicator = document.getElementById('connectionIndicator');
    const connectionText = document.getElementById('connectionText');
    const totalUsersEl = document.getElementById('totalUsers');
    const queueLengthEl = document.getElementById('queueLength');
    const unityCountEl = document.getElementById('unityCount');
    const activeUserSection = document.getElementById('activeUserSection');
    const queueList = document.getElementById('queueList');
    const avatarStateText = document.getElementById('avatarStateText');
    const serverUrlEl = document.getElementById('serverUrl');
    const connectedTimeEl = document.getElementById('connectedTime');
    const unityClientsCountEl = document.getElementById('unityClientsCount');

    // ========== LOGIN ==========
    passwordInput.addEventListener('input', () => {
      loginBtn.disabled = passwordInput.value.trim().length === 0;
      errorMessage.classList.remove('show');
    });

    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !loginBtn.disabled) {
        loginBtn.click();
      }
    });

    loginBtn.addEventListener('click', () => {
      if (passwordInput.value === ADMIN_PASSWORD) {
        isAuthenticated = true;
        loginScreen.style.display = 'none';
        adminPanel.classList.add('active');
        connectToRelay();
      } else {
        errorMessage.classList.add('show');
        passwordInput.value = '';
        passwordInput.focus();
      }
    });

    // ========== RELAY CONNECTION ==========
    function connectToRelay() {
      try {
        updateConnectionStatus('connecting');
        
        relaySocket = new WebSocket(RELAY_SERVER_URL);
        
        relaySocket.onopen = () => {
          console.log('Connected to relay server');
          connectedAt = new Date();
          updateConnectionStatus('connected');
          serverUrlEl.textContent = RELAY_SERVER_URL;
          
          // Identify as admin
          relaySocket.send(JSON.stringify({
            type: 'identify',
            client: 'admin'
          }));

          // Request current state
          relaySocket.send(JSON.stringify({
            type: 'admin_get_state'
          }));
        };

        relaySocket.onmessage = (event) => {
          handleServerMessage(event.data);
        };

        relaySocket.onclose = () => {
          console.log('Disconnected from relay server');
          updateConnectionStatus('disconnected');
          
          // Attempt reconnect after 3 seconds
          setTimeout(() => {
            if (isAuthenticated) {
              connectToRelay();
            }
          }, 3000);
        };

        relaySocket.onerror = (error) => {
          console.error('Relay server error:', error);
          updateConnectionStatus('error');
        };
        
      } catch (error) {
        console.error('Failed to connect to relay:', error);
        updateConnectionStatus('error');
      }
    }

    // ========== SERVER MESSAGE HANDLER ==========
    function handleServerMessage(data) {
      try {
        const message = JSON.parse(data);
        console.log('Admin received:', message);
        
        switch (message.type) {
          case 'admin_state_update':
            updateDashboard(message);
            break;
            
          default:
            console.log('Unknown message type:', message.type);
        }
        
      } catch (error) {
        console.error('Error processing server message:', error);
      }
    }

    // ========== UPDATE DASHBOARD ==========
    function updateDashboard(state) {
      activeUser = state.activeUser;
      waitingQueue = state.waitingQueue || [];
      unityCount = state.unityClients || 0;
      avatarState = state.avatarState || 'idle';

      // Update stats
      totalUsersEl.textContent = (activeUser ? 1 : 0) + waitingQueue.length;
      queueLengthEl.textContent = waitingQueue.length;
      unityCountEl.textContent = unityCount;
      unityClientsCountEl.textContent = unityCount;

      // Update avatar state
      avatarStateText.textContent = avatarState === 'idle' ? 'Libero' : 'Occupato';
      avatarStateText.style.color = avatarState === 'idle' ? '#10b981' : '#ef4444';

      // Update active user section
      renderActiveUser();

      // Update queue
      renderQueue();

      // Update connected time
      if (connectedAt) {
        const elapsed = Math.floor((new Date() - connectedAt) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        connectedTimeEl.textContent = `${minutes}m ${seconds}s`;
      }
    }

    // ========== RENDER ACTIVE USER ==========
    function renderActiveUser() {
      if (!activeUser) {
        activeUserSection.innerHTML = '<div class="empty-state">Nessun utente attivo</div>';
        activeUserSection.classList.add('empty');
        return;
      }

      activeUserSection.classList.remove('empty');
      
      const startTime = new Date(activeUser.startTime);
      const elapsed = Math.floor((new Date() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;

      activeUserSection.innerHTML = `
        <div class="user-info">
          <div>
            <div class="name">${activeUser.username}</div>
            <div class="id">${activeUser.userId}</div>
          </div>
          <div style="text-align: right; font-size: 12px; color: #6b7280;">
            Attivo da: ${minutes}m ${seconds}s
          </div>
        </div>
        <div class="user-actions">
          <button class="btn btn-danger btn-small" onclick="closeConversation()">
            <span>üö™</span>
            <span>Chiudi Conversazione</span>
          </button>
          <button class="btn btn-warning btn-small" onclick="demoteToQueue()">
            <span>‚¨áÔ∏è</span>
            <span>Metti in Coda</span>
          </button>
        </div>
      `;
    }

    // ========== RENDER QUEUE ==========
    function renderQueue() {
      if (waitingQueue.length === 0) {
        queueList.innerHTML = '<div class="empty-state">Nessun utente in coda</div>';
        return;
      }

      queueList.innerHTML = waitingQueue.map((user, index) => {
        const joinTime = new Date(user.joinTime);
        const elapsed = Math.floor((new Date() - joinTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;

        return `
          <div class="queue-item">
            <div class="queue-item-details">
              <div class="queue-item-position">${index + 1}</div>
              <div class="queue-item-info">
                <div class="queue-item-name">${user.username}</div>
                <div class="queue-item-id">${user.userId}</div>
                <div class="queue-item-time">In attesa da: ${minutes}m ${seconds}s</div>
              </div>
            </div>
            <div class="queue-item-actions">
              <div class="move-controls">
                <button class="move-btn" onclick="moveUp(${index})" ${index === 0 ? 'disabled' : ''}>
                  ‚ñ≤
                </button>
                <button class="move-btn" onclick="moveDown(${index})" ${index === waitingQueue.length - 1 ? 'disabled' : ''}>
                  ‚ñº
                </button>
              </div>
              <button class="btn btn-primary btn-small" onclick="promoteUser(${index})">
                <span>‚¨ÜÔ∏è</span>
                <span>Promuovi</span>
              </button>
              <button class="btn btn-danger btn-small" onclick="removeFromQueue(${index})">
                <span>‚ùå</span>
                <span>Rimuovi</span>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== ADMIN ACTIONS ==========
    function closeConversation() {
      if (confirm('Vuoi chiudere questa conversazione?')) {
        sendAdminCommand('close_conversation', {
          userId: activeUser.userId
        });
      }
    }

    function demoteToQueue() {
      if (confirm('Vuoi mettere questo utente in coda?')) {
        sendAdminCommand('demote_to_queue', {
          userId: activeUser.userId
        });
      }
    }

    function promoteUser(index) {
      sendAdminCommand('promote_user', {
        index: index
      });
    }

    function removeFromQueue(index) {
      if (confirm('Vuoi rimuovere questo utente dalla coda?')) {
        sendAdminCommand('remove_from_queue', {
          index: index
        });
      }
    }

    function moveUp(index) {
      if (index > 0) {
        sendAdminCommand('move_in_queue', {
          fromIndex: index,
          toIndex: index - 1
        });
      }
    }

    function moveDown(index) {
      if (index < waitingQueue.length - 1) {
        sendAdminCommand('move_in_queue', {
          fromIndex: index,
          toIndex: index + 1
        });
      }
    }

    // ========== SEND ADMIN COMMAND ==========
    function sendAdminCommand(action, data = {}) {
      if (relaySocket && relaySocket.readyState === WebSocket.OPEN) {
        relaySocket.send(JSON.stringify({
          type: 'admin_command',
          action: action,
          ...data
        }));
      }
    }

    // ========== CONNECTION STATUS ==========
    function updateConnectionStatus(status) {
      switch (status) {
        case 'connected':
          connectionIndicator.className = 'status-indicator connected';
          connectionText.textContent = 'Connesso';
          break;
        case 'connecting':
          connectionIndicator.className = 'status-indicator';
          connectionIndicator.style.background = '#f59e0b';
          connectionText.textContent = 'Connessione...';
          break;
        case 'disconnected':
        case 'error':
          connectionIndicator.className = 'status-indicator disconnected';
          connectionText.textContent = 'Disconnesso';
          break;
      }
    }

    // ========== AUTO UPDATE TIME ==========
    setInterval(() => {
      if (activeUser || waitingQueue.length > 0) {
        renderActiveUser();
        renderQueue();
      }
      
      if (connectedAt) {
        const elapsed = Math.floor((new Date() - connectedAt) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        connectedTimeEl.textContent = `${minutes}m ${seconds}s`;
      }
    }, 1000);
